<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>需求-代码一致性标注平台</title>
    <link rel="stylesheet" href="../static/css/annotation.css">
    <link rel="stylesheet" href="../static/fontawesome/css/all.css">
    <link rel="stylesheet" href="../static/js/thirdParty/highlight/default.min.css">
    <link rel="stylesheet" href="../static/js/thirdParty/katex/katex.min.css">
    <link rel="stylesheet" href="../static/js/thirdParty/element/index.css">

    <script src="../static/js/thirdParty/vue.global.js"></script>
    <script src="../static/js/thirdParty/axios.min.js"></script>
    <script src="../static/js/thirdParty/element/index.full.js"></script>
    <script src="../static/js/thirdParty/element/icons-vue.js"></script>
    <script src="../static/js/thirdParty/katex/katex.min.js"></script>
    <script src="../static/js/thirdParty/auto-render.min.js"></script>
    <script src="../static/js/thirdParty/highlight/highlight.min.js"></script>
    <script src="../static/js/thirdParty/texmath.min.js"></script>
    <script src="../static/js/thirdParty/markdown-it.min.js"></script>
</head>
<body>
<div id="app">
    <!-- 顶部菜单栏 -->
    <div class="header">
        <div class="header-title">
            <i class="fas fa-code-branch"></i> 
            <span>  需求-代码一致性标注</span>
        </div>
        <div class="button-group">
            <el-tooltip effect="light" :content="`新建标注任务`" placement="bottom">
                <button class="header-button" @click="handleNewTask">
                    <i class="fas fa-file-circle-plus"></i>
                </button>
            </el-tooltip>
            <el-tooltip effect="light" :content="`导入标注`" placement="bottom">
                <button class="header-button" @click="handleImportAnnotations">
                    <i class="fas fa-download"></i>
                </button>
            </el-tooltip>
            <el-tooltip effect="light" :content="`导出标注`" placement="bottom">
                <button class="header-button" @click="handleExportAnnotations">
                    <i class="fas fa-upload"></i>
                </button>
            </el-tooltip>
        </div>
    </div>
    
    <div class="main-container">
        <el-splitter>
            <!-- 侧边栏 -->
            <el-splitter-panel class="sidebar" collapsible size="200px">
                <div class="sidebar-header">
                    <div class="sidebar-title">
                        <span>标注项目</span>
                    </div>
                </div>
                
                <div class="file-tree">
                    <div class="file-category">
                        <div class="category-header">
                            <div class="category-title">
                                <i class="fas fa-file-alt"></i> 
                                <span>需求文档</span>
                                <span class="file-count"> (${docFiles.length})</span>
                            </div>
                            <div class="category-actions">
                                <el-button type="primary" size="small" plain @click="triggerDocUpload">上传</el-button>
                            </div>
                        </div>
                        <div class="file-items">
                            <div v-if="docFiles.length === 0" class="file-item empty-item">
                                暂无需求文档
                            </div>
                            <div v-for="(file, index) in docFiles" 
                                :key="'doc-'+index" 
                                class="file-item"
                                :class="{ 'selected': selectedDocFile === file.name }">
                                <div class="file-info" @click="selectDocFile(file)">
                                    <i class="fas fa-file-word"></i>
                                    <span class="file-name">${ file.name }</span>
                                </div>
                                <div class="file-actions">
                                    <el-button size="small" link @click.stop="removeDocFile(index)">×</el-button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="file-category">
                        <div class="category-header">
                            <div class="category-title">
                                <i class="fas fa-code"></i> 
                                <span>代码文件</span>
                                <span class="file-count"> (${codeFiles.length})</span>
                            </div>
                            <div class="category-actions">
                                <el-button type="primary" size="small" plain @click="triggerCodeUpload">上传</el-button>
                            </div>
                        </div>
                        <div class="file-items">
                            <div v-if="codeFiles.length === 0" class="file-item empty-item">
                                暂无代码文件
                            </div>
                            <div v-for="(file, index) in codeFiles" 
                                :key="'code-'+index" 
                                class="file-item"
                                :class="{ 'selected': selectedCodeFile === file.name }">
                                <div class="file-info" @click="selectCodeFile(file)">
                                    <i class="fas fa-file-code"></i>
                                    <span class="file-name">${ file.name }</span>
                                </div>
                                <div class="file-actions">
                                    <el-button size="small"  link @click.stop="removeCodeFile(index)">×</el-button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </el-splitter-panel>

            <el-splitter-panel class="main-content">
                <el-splitter>
                    <!-- 文档展示区域 -->
                    <el-splitter-panel class="split-panel req-panel" :min="200" size="40%">
                        <div class="panel-title">
                            <i class="fas fa-file-word"></i> <span>${ selectedDocFile || '请选择需求文档' }</span>
                        </div>
                        <div class="content-card">
                            <div v-if="renderError" class="render-error-message">
                                <i class="fas fa-exclamation-triangle"></i> 
                                渲染错误: ${ renderError }
                            </div>
                            <div class="content-text-doc" v-html="selectedDocContent"></div>
                        </div>
                    </el-splitter-panel>

                    <!-- 代码展示区域 -->
                    <el-splitter-panel class="split-panel code-panel" :min="200" size="40%">
                        <div class="panel-title">
                            <i class="fas fa-file-code"></i> <span>${ selectedCodeFile || '请选择代码文件' }</span>
                        </div>
                        <div class="content-card">
                            <pre class="content-text-code" v-html="selectedCodeContent"></pre>
                        </div>
                    </el-splitter-panel>

                    <!-- 标注结果 -->
                    <el-splitter-panel class="split-panel annotation-panel" collapsible>
                        <div class="panel-title">
                            <i class="fas fa-comments"></i> <span>标注</span>
                        </div>
                        <div class="content-card">
                            <!-- 标注列表 -->
                            <div class="annotation-list">
                                <el-collapse>
                                    <el-collapse-item 
                                        v-for="(anno, index) in annotations" 
                                        :key="anno.id"
                                        :title="anno.category"
                                    >
                                        <template #title>
                                            <div class="annotation-header">
                                                <el-tooltip effect="light" :content="anno.category" placement="top">
                                                    <span class="annotation-title">${ anno.category }</span>
                                                </el-tooltip>
                                                <el-button-group>
                                                    <el-button 
                                                        class="custom-button"
                                                        type="primary"
                                                        link
                                                        @click.stop="editAnnotation(anno)"
                                                    >重命名</el-button>
                                                    <el-button 
                                                        class="custom-button"
                                                        type="danger"
                                                        link
                                                        @click.stop="removeAnnotation(index)"
                                                    >删除</el-button>
                                                </el-button-group>
                                            </div>
                                        </template>
                                        
                                        <div class="annotation-content">
                                            <!-- 文档范围 -->
                                            <div v-if="anno.docRanges.length > 0" class="annotation-section">
                                                <h4>需求文档范围</h4>
                                                <div v-for="(range, rIndex) in anno.docRanges" :key="'doc-'+rIndex" class="range-item">
                                                    <div class="range-header">
                                                        <span>${ range.documentId }</span>
                                                        <el-button 
                                                            type="danger" 
                                                            size="small" 
                                                            link
                                                            @click="removeRange(anno, 'doc', rIndex)"
                                                        >×</el-button>
                                                    </div>
                                                    <div class="range-content" @click="gotoRange(range, 'doc')">
                                                        <el-tooltip effect="light" :content="range.content" placement="top">
                                                            <div class="truncated-text">${ range.content }</div>
                                                        </el-tooltip>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- 代码范围 -->
                                            <div v-if="anno.codeRanges.length > 0" class="annotation-section">
                                                <h4>代码范围</h4>
                                                <div v-for="(range, rIndex) in anno.codeRanges" :key="'code-'+rIndex" class="range-item">
                                                    <div class="range-header">
                                                        <span>${ range.documentId }</span>
                                                        <el-button 
                                                            type="danger" 
                                                            size="small"
                                                            link
                                                            @click="removeRange(anno, 'code', rIndex)"
                                                        >×</el-button>
                                                    </div>
                                                    <div class="range-content" @click="gotoRange(range, 'code')">
                                                        <el-tooltip effect="light" :content="range.content" placement="top">
                                                            <pre class="truncated-code">${ range.content }</pre>
                                                        </el-tooltip>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div v-if="anno.docRanges.length === 0 && anno.codeRanges.length === 0" class="empty-ranges">
                                                此标注中没有添加任何范围
                                            </div>
                                        </div>
                                    </el-collapse-item>
                                </el-collapse>
                                
                                <div v-if="annotations.length === 0" class="empty-annotations">
                                    暂无标注，请在文档或代码中选择文本创建标注
                                </div>
                            </div>
                        </div>
                    </el-splitter-panel>

                    <!-- 标注对话框 -->
                    <el-dialog 
                        v-model="showAnnotationDialog" 
                        title="新建标注" 
                        width="500px"
                        :close-on-click-modal="false"
                    >
                        <div v-if="currentSelection">
                            <div class="selection-preview">
                                ${ currentSelection.content }
                            </div>
                            
                            <div class="annotation-options">
                                <div style="display: flex; margin-bottom: 15px; gap: 10px;">
                                    <el-input 
                                        v-model="annotationName" 
                                        placeholder="输入标注名称" 
                                    ></el-input>
                                    
                                    <el-button 
                                        type="primary" 
                                        @click="createAnnotation"
                                    >
                                        创建新标注
                                    </el-button>
                                </div>                                                         
                                
                                <div v-if="annotations.length > 0">
                                    <p style="margin: 10px 0 5px; font-size: 14px;">添加到现有标注:</p>
                                    
                                    <el-dropdown 
                                        placement="bottom" 
                                        trigger="click" 
                                        size="small"
                                        style="width: 100%"
                                    >
                                        <el-button style="width: 100%; text-align: left;">
                                            选择标注...
                                            <el-icon class="el-icon--right"><arrow-down /></el-icon>
                                        </el-button>
                                        
                                        <template #dropdown>
                                            <el-dropdown-menu class="annotation-dropdown-menu">
                                                <el-dropdown-item 
                                                    v-for="anno in annotations" 
                                                    :key="anno.id"
                                                    @click="addToAnnotation(anno)"
                                                >
                                                    <div class="dropdown-item-content">
                                                        <span class="dropdown-annotation-name">${ anno.category }</span>
                                                        <span class="dropdown-annotation-date">${ formatDate(anno.updateTime) }</span>
                                                    </div>
                                                </el-dropdown-item>
                                            </el-dropdown-menu>
                                        </template>
                                    </el-dropdown>
                                </div>
                            </div>
                        </div>
                    </el-dialog>

                    <!-- 编辑标注对话框 -->
                    <el-dialog 
                        v-model="editingAnnotation" 
                        title="编辑标注名称" 
                        width="400px"
                        :close-on-click-modal="false"
                    >
                        <el-input v-model="annotationName" placeholder="输入新标注名称"></el-input>
                        <template #footer>
                            <el-button @click="editingAnnotation = false">取消</el-button>
                            <el-button type="primary" @click="saveAnnotationName">保存</el-button>
                        </template>
                    </el-dialog>
                </el-splitter>
            </el-splitter-panel>
        </el-splitter>
    </div>
    
    <!-- 隐藏的文件上传输入 -->
    <input type="file" ref="docUpload" style="display: none" accept=".md,.txt,.docx,.doc" @change="handleDocUpload">
    <input type="file" ref="codeUpload" style="display: none" accept=".js,.py,.java,.c,.cpp,.cs,.html,.css" @change="handleCodeUpload">
</div>

<script type="module" src="/static/js/annotation.js"></script>
</body>
</html>