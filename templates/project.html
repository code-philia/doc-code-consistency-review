<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>需求-代码一致性审查平台</title>
    <link rel="stylesheet" href="../static/css/project.css">
    <link rel="stylesheet" href="../static/fontawesome/css/all.css">
    <link rel="stylesheet" href="../static/js/thirdParty/highlight/default.min.css">
    <link rel="stylesheet" href="../static/js/thirdParty/katex/katex.min.css">
    <link rel="stylesheet" href="../static/js/thirdParty/element/index.css">
    <link rel="stylesheet" href="../static/js/thirdParty/element/index.iife.min.js">


    <script src="../static/js/thirdParty/vue.global.js"></script>
    <script src="../static/js/thirdParty/axios.min.js"></script>
    <script src="../static/js/thirdParty/element/index.full.js"></script>
    <script src="../static/js/thirdParty/element/icons-vue.js"></script>
    <script src="../static/js/thirdParty/katex/katex.min.js"></script>
    <script src="../static/js/thirdParty/auto-render.min.js"></script>
    <script src="../static/js/thirdParty/axios.min.js"></script>
    <script src="../static/js/thirdParty/highlight/highlight.min.js"></script>
    <script src="../static/js/thirdParty/texmath.min.js"></script>
    <script src="../static/js/thirdParty/markdown-it.min.js"></script>
</head>
<body>
<div id="app">
    <!-- 顶部菜单栏 -->
    <div class="header">
        <div class="menu">
            <div class="menu-item">
                项目
                <div class="dropdown">
                    <div class="dropdown-item"><i class="fas fa-folder-plus"></i> 新的项目</div>
                    <div class="dropdown-item"><i class="fas fa-folder-open"></i> 导入项目</div>
                    <div class="dropdown-item"><i class="fas fa-file-export"></i> 导出项目</div>
                    <div class="dropdown-item" onclick="window.history.back()">
                        <i class="fas fa-times-circle"></i> 关闭项目
                    </div>
                </div>
            </div>
            <div class="menu-item">
                文件
                <div class="dropdown">
                    <div class="dropdown-item" @click="addFile('doc', 'file')"><i class="fas fa-file-alt"></i> 添加需求文档 (单个)</div>
                    <div class="dropdown-item" @click="addFile('doc', 'folder')"><i class="fas fa-folder"></i> 添加需求文档 (文件夹)</div>
                    <div class="dropdown-item" @click="addFile('code', 'file')"><i class="fas fa-file-code"></i> 添加代码文件 (单个)</div>
                    <div class="dropdown-item" @click="addFile('code', 'folder')"><i class="fas fa-folder"></i> 添加代码文件 (文件夹)</div>
                </div>
            </div>
            <div class="menu-item">
                智能工具
                <div class="dropdown">
                    <div class="dropdown-item"><i class="fas fa-sitemap"></i> 需求分解</div>
                    <div class="dropdown-item"><i class="fas fa-link"></i> 自动对齐</div>
                    <div class="dropdown-item"><i class="fas fa-tasks"></i> 自动审查</div>
                </div>
            </div>
        </div>
        <div class="view-switcher">
            <button id="statsButton" class="view-btn active" onclick="switchView('stats')">统计视图</button>
            <button id="alignmentButton" class="view-btn" onclick="switchView('alignment')">功能视图</button>
        </div>
    </div>
    
    <div class="main-container">
        <el-splitter>
            <!-- 侧边栏 -->
            <el-splitter-panel  class="sidebar" collapsible size="200px">
                <div class="sidebar-header">
                    <div class="sidebar-title">
                        <span id="projectName">${projectName}</span>
                    </div>
                </div>
                
                <div class="file-tree">
                    <div class="file-category">
                        <div class="category-header">
                            <i class="fas fa-file-alt"></i> <span>需求文档</span>
                            <span class="file-count">(${projectFiles.doc_files.length})</span>
                        </div>
                        <div class="file-items">
                            <div v-if="projectFiles.doc_files.length === 0" class="file-item empty-item">
                                暂无需求文档
                            </div>
                            <el-tree
                                v-else
                                :data="docFileTree"
                                :props="{ label: 'label', children: 'children' }"
                                @node-click="handleNodeClick"
                                :expand-on-click-node="false"
                                node-key="path"
                                empty-text="">
                                <template #default="{ node, data }">
                                    <span class="file-item req-file" :class="{ 'selected': data.path === selectedDocFile && data.type === 'file' }">
                                        <i :class="data.icon"></i>
                                        <span class="file-name">${ node.label }</span>
                                    </span>
                                </template>
                            </el-tree>
                        </div>
                        </div>

                    <div class="file-category">
                        <div class="category-header">
                            <i class="fas fa-code"></i> <span>代码文件</span>
                            <span class="file-count">(${projectFiles.code_files.length})</span>
                        </div>
                        <div class="file-items">
                            <div v-if="projectFiles.code_files.length === 0" class="file-item empty-item">
                                暂无代码文件
                            </div>
                            <el-tree
                                v-else
                                :data="codeFileTree"
                                :props="{ label: 'label', children: 'children' }"
                                @node-click="handleNodeClick"
                                :expand-on-click-node="false"
                                node-key="path"
                                empty-text="">
                                <template #default="{ node, data }">
                                    <span class="file-item code-file" :class="{ 'selected': data.path === selectedCodeFile && data.type === 'file' }">
                                        <i :class="data.icon"></i>
                                        <span class="file-name">${ node.label }</span>
                                    </span>
                                </template>
                            </el-tree>
                        </div>
                    </div>
                    
                    <div class="file-category">
                        <div class="category-header">
                            <i class="fas fa-cog"></i> <span>项目元信息</span>
                            <span class="file-count">(${projectFiles.meta_files.length})</span>
                        </div>
                        <div class="file-items">
                            <div v-for="file in projectFiles.meta_files" :key="file" class="file-item proj-file"
                                :class="{ 'selected': file === selectedMetaFile }" >
                                <i class="fas fa-project-diagram"></i>
                                <span class="file-name">${ file }</span>
                            </div>
                        </div>
                    </div>
                </div>
            </el-splitter-panel>

            <el-splitter-panel class="main-content">
                <!-- 项目视图（默认显示） -->
                <div class="stats-view" id="statsView">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-title">
                                <i class="fas fa-file-alt"></i> 需求文档
                            </div>
                            <div class="stat-value">${ projectFiles.doc_files.length }</div>
                            <div class="stat-description">当前项目中的需求文档总数</div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-title">
                                <i class="fas fa-code"></i> 代码文件
                            </div>
                            <div class="stat-value">${ projectFiles.code_files.length }</div>
                            <div class="stat-description">当前项目中的代码文件总数</div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-title">
                                <i class="fas fa-link"></i> 需求-代码对齐对数
                            </div>
                            <div class="stat-value">127</div>
                            <div class="stat-description">已确认的需求与代码对应关系</div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-title">
                                <i class="fas fa-bug"></i> 问题单总数
                            </div>
                            <div class="stat-value">42</div>
                            <div class="stat-description">发现的问题单条目总数</div>
                            <div class="progress-stat">
                                <div class="progress-label">
                                    <span>已解决</span>
                                    <span>78%</span>
                                </div>
                                <div class="progress-big">
                                    <div class="progress-big-bar" style="width: 78%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <h3 style="margin-bottom: 15px; color: var(--text-primary);">
                        <i class="fas fa-file-alt"></i> 需求文档对齐进度
                    </h3>
                    <table class="files-table">
                        <thead>
                            <tr>
                                <th class="file-icon-cell"></th>
                                <th>文件名</th>
                                <th>对齐进度</th>
                                <th>对齐需求数</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="file in projectFiles.doc_files" :key="file">
                                <td class="file-icon-cell"><i class="fas fa-file-alt file-icon"></i></td>
                                <td>${ file }</td>
                                <td class="file-progress-cell">
                                    <div class="file-progress">
                                        <span class="file-progress-value">85%</span>
                                        <div class="file-progress-bar">
                                            <div class="file-progress-fill" style="width: 85%"></div>
                                        </div>
                                    </div>
                                </td>
                                <td>76/89</td>
                            </tr>
                            <tr v-if="projectFiles.doc_files.length === 0">
                                <td colspan="4" class="empty-message">暂无需求文档</td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <h3 style="margin: 25px 0 15px; color: var(--text-primary);">
                        <i class="fas fa-code"></i> 代码文件对齐进度
                    </h3>
                    <table class="files-table">
                        <thead>
                            <tr>
                                <th class="file-icon-cell"></th>
                                <th>文件名</th>
                                <th>对齐进度</th>
                                <th>覆盖需求数</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="file in projectFiles.code_files" :key="file">
                                <td class="file-icon-cell"><i class="fas fa-file-code file-icon"></i></td>
                                <td>${ file }</td>
                                <td class="file-progress-cell">
                                    <div class="file-progress">
                                        <span class="file-progress-value">85%</span>
                                        <div class="file-progress-bar">
                                            <div class="file-progress-fill" style="width: 85%"></div>
                                        </div>
                                    </div>
                                </td>
                                <td>76/89</td>
                            </tr>
                            <tr v-if="projectFiles.code_files.length === 0">
                                <td colspan="4" class="empty-message">暂无代码文件</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- 对齐视图 -->
                <div class="alignment-view split-view" id="alignmentView">
                    <el-splitter layout="vertical">
                        <el-splitter-panel :min="200" size="100%">
                            <el-splitter>
                                <el-splitter-panel class="split-panel req-panel" :min="200" size="50%">
                                    <div class="panel-title">
                                        <i class="fas fa-file-word"></i> <span>${ selectedDocFile || '请选择需求文档' }</span>
                                    </div>
                                    <div class="content-card">
                                        <div class="content-text-doc" v-html="selectedDocContent" @mouseup="handleDocSelection"></div>
                                    </div>
                                </el-splitter-panel>
                                <el-splitter-panel class="split-panel code-panel" :min="200" size="50%">
                                    <div class="panel-title">
                                        <i class="fas fa-file-code"></i> <span>${ selectedCodeFile || '请选择代码文件' }</span>
                                    </div>
                                    <div class="content-card">
                                        <pre class="content-text-code" v-html="selectedCodeContent"></pre>
                                    </div>
                                </el-splitter-panel>
                                <el-splitter-panel class="split-panel right-sidebar" collapsible>
                                    <div class="panel-title">
                                        <i class="fas fa-link"></i>
                                        <span>对齐与审查</span>
                                    </div>
                                    <div class="content-card">
                                        <div class="alignment-list">
                                            <el-collapse v-if="alignmentResults.length > 0">
                                                <el-collapse-item 
                                                    v-for="(alignment, index) in alignmentResults" 
                                                    :key="alignment.id"
                                                    :title="alignment.name"
                                                    @contextmenu.prevent="showContextMenu($event, alignment)"
                                                >
                                                    <template #title>
                                                        <div class="alignment-header">
                                                            <el-tooltip effect="light" :content="alignment.name" placement="top">
                                                                <span class="alignment-title">${ alignment.name }</span>
                                                            </el-tooltip>
                                                            <el-tag 
                                                                :type="alignment.hasReview ? 'success' : 'info'" 
                                                                size="small" 
                                                                class="review-tag"
                                                            >
                                                                ${ alignment.hasReview ? '已审查' : '未审查' }
                                                            </el-tag>
                                                        </div>
                                                    </template>
                                                    
                                                    <div class="alignment-content">
                                                        <div v-if="alignment.docRanges.length > 0" class="alignment-section">
                                                            <h4>需求文档范围</h4>
                                                            <div v-for="(range, rIndex) in alignment.docRanges" :key="'doc-'+rIndex" class="range-item">
                                                                <div class="range-header">
                                                                    <span>${ range.documentId }</span>
                                                                    <el-button 
                                                                        type="danger" 
                                                                        size="small"
                                                                        link
                                                                    >×</el-button>
                                                                </div>
                                                                <div class="range-content">
                                                                    <el-tooltip effect="light" :content="range.content" placement="top">
                                                                        <pre class="truncated-code">${ range.content }</pre>
                                                                    </el-tooltip>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div v-if="alignment.codeRanges.length > 0" class="alignment-section">
                                                            <h4>代码范围</h4>
                                                            <div v-for="(range, rIndex) in alignment.codeRanges" :key="'code-'+rIndex" class="range-item">
                                                                <div class="range-header">
                                                                    <span>${ range.documentId }</span>
                                                                    <el-button 
                                                                        type="danger" 
                                                                        size="small"
                                                                        link
                                                                    >×</el-button>
                                                                </div>
                                                                <div class="range-content">
                                                                    <el-tooltip effect="light" :content="range.content" placement="top">
                                                                        <pre class="truncated-code">${ range.content }</pre>
                                                                    </el-tooltip>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </el-collapse-item>
                                            </el-collapse>
                                            <div v-else class="empty-message">
                                                暂无对齐结果
                                            </div>
                                        </div>
                                    </div>
                                </el-splitter-panel>
                            </el-splitter>
                        </el-splitter-panel>

                        <el-splitter-panel class="bottom-bar" id="bottomBar" collapsible>
                            <div class="bottom-bar-content">
                                <div class="issue-header-bar">
                                    <div class="issue-title-bar">
                                        <h3><i class="fas fa-exclamation-triangle"></i> 问题单列表 (${issues.length})</h3>
                                        <span v-if="issues.length === 0" class="no-issues-text">
                                            当前对齐视图中暂无问题。
                                        </span>
                                    </div>
                                    <div class="issue-actions">
                                        <button class="action-btn" @click="confirmIssue">
                                            <i class="fas fa-check"></i> 确认
                                        </button>
                                        <button class="action-btn secondary" @click="ignoreIssue">
                                            <i class="fas fa-times"></i> 忽略
                                        </button>
                                    </div>
                                </div>
                                <div class="issue-table" v-if="issues.length > 0">
                                    <div class="issue-row issue-header-row">
                                        <div class="issue-cell issue-level-cell">等级</div>
                                        <div class="issue-cell issue-description-cell">问题描述</div>
                                        <div class="issue-cell issue-req-cell">相关需求</div>
                                        <div class="issue-cell issue-code-cell">相关代码</div>
                                        <div class="issue-cell issue-status-cell">状态</div>
                                    </div>
                                    <div
                                        v-for="(issue, index) in issues"
                                        :key="index"
                                        class="issue-row"
                                        :class="{ 'selected': issue === selectedIssue }"
                                        @click="selectIssue(issue)"
                                    >
                                        <div class="issue-cell issue-level-cell">
                                            <span class="issue-level" :class="issue.level">${ issue.level }</span>
                                        </div>
                                        <div class="issue-cell issue-description-cell">${ issue.description }</div>
                                        <div class="issue-cell issue-req-cell">${ issue.relatedReq }</div>
                                        <div class="issue-cell issue-code-cell">${ issue.relatedCode }</div>
                                        <div class="issue-cell issue-status-cell">
                                            <span class="issue-status" :class="issue.status">${ issue.status === 'confirmed' ? '已确认' : '未确认' }</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </el-splitter-panel>
                    </el-splitter>

                    <div 
                        v-if="contextMenu.visible" 
                        class="context-menu" 
                        :style="{ top: contextMenu.top + 'px', left: contextMenu.left + 'px' }"
                    >
                        <div class="context-menu-item" @click="renameAlignment">
                            <i class="fas fa-pen"></i> 重命名
                        </div>
                        <div class="context-menu-item" @click="deleteAlignment">
                            <i class="fas fa-trash"></i> 删除
                        </div>
                    </div>
                </div>
            </el-splitter-panel>
        </el-splitter>

        <el-dialog 
            v-model="showAlignmentDialog" 
            title="新建需求点" 
            width="500px"
            :close-on-click-modal="false"
        >
            <div v-if="currentSelection">
                <div class="selection-preview">
                    ${ currentSelection.content }
                </div>
                 <el-input
                    v-model="newAlignmentName"
                    placeholder="为该需求点命名"
                    style="margin-top: 5px;"
                ></el-input>
            </div>
            <template #footer>
                <el-button @click="showAlignmentDialog = false">取消</el-button>
                <el-button type="primary" @click="createAlignment">创建</el-button>
            </template>
        </el-dialog>

    </div>
</div>

<script type="module" src="/static/js/project.js"></script>
</body>
</html>